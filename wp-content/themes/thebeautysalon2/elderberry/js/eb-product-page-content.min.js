function serialize(e){var t,n,r,i="",s="",o=0,u=function(e){var t=0,n=0,r=e.length,i="";for(n=0;n<r;n++){i=e.charCodeAt(n);i<128?t+=1:i<2048?t+=2:t+=3}return t},a=function(e){var t,n,r,i,s=typeof e;if(s==="object"&&!e)return"null";if(s==="object"){if(!e.constructor)return"object";r=e.constructor.toString();t=r.match(/(\w+)\(/);t&&(r=t[1].toLowerCase());i=["boolean","number","string","array"];for(n in i)if(r==i[n]){s=i[n];break}}return s},f=a(e);switch(f){case"function":t="";break;case"boolean":t="b:"+(e?"1":"0");break;case"number":t=(Math.round(e)==e?"i":"d")+":"+e;break;case"string":t="s:"+u(e)+':"'+e+'"';break;case"array":case"object":t="a";for(n in e)if(e.hasOwnProperty(n)){i=a(e[n]);if(i==="function")continue;r=n.match(/^[0-9]+$/)?parseInt(n,10):n;s+=this.serialize(r)+this.serialize(e[n]);o++}t+=":"+o+":{"+s+"}";break;case"undefined":default:t="N"}f!=="object"&&f!=="array"&&(t+=";");return t}(function(e,t,n,r){function s(t,n){t.config=e.extend({},i,n);t.pagination_links=t.find(".product-page-pagination span.page-link");t.sortables=t.find(".sortable");t.pages=t.find(".page");t.add=t.find(".add");t.data=t.find(".category-data");t.structure=t.find(".structure");t.add_page=t.find(".add_page");t.delete_page=t.find(".delete-page");t.new_category=t.find(".new-category");t.find(".new-category-container").hide();t.category_select=t.new_category.find("select")}var i={};e.fn.product_control=function(t){function r(){structure=u();n.structure.val(serialize(structure));o()}function i(){n.pages.length>1?n.find(".delete-page").show():n.find(".delete-page").hide()}function o(){e.each(e(".page-side .sortable"),function(){e(this).find(".category").length==0&&e(this).find(".no-products").length==0?e(this).prepend('<div class="no-products">click on the button below to add a category box</div>'):e(this).find(".category").length>0&&e(this).find(".no-products").remove()})}function u(){var t=[];e.each(n.pages,function(n){t[n]=[];t[n].left=[];t[n].right=[];e.each(e(this).find(".left .category"),function(){t[n].left.push(e(this).attr("data-id"))});e.each(e(this).find(".right .category"),function(){t[n].right.push(e(this).attr("data-id"))})});return t}function a(){e.each(n.pagination_links,function(t){e(this).html(e(this).index()+1)});n.pagination_links=n.find(".product-page-pagination span.page-link")}function f(){n.pages=n.find(".page")}new s(this,t);var n=this;o();i();n.sortables.sortable({connectWith:".sortable",placeholder:"placeholder",tolerance:"intersect"});n.sortables.disableSelection();n.pagination_links.live("click",function(){index=e(this).index();n.pagination_links.removeClass("current");e(this).addClass("current");n.pages.eq(index).show();n.pages.not(":eq("+index+")").hide()});n.find("span.remove").live("click",function(){e(this).parents(".category").fadeOut(function(){e(this).remove();r()})});n.add.live("click",function(){e(this).before(n.new_category)});n.category_select.live("change",function(){category_id=e(this).val();category_box=n.data.find('.category[data-id="'+category_id+'"]').clone();e(this).parents(".page-side").find(".sortable").append(category_box);r();e(this).find("option").removeAttr("selected");e(this).trigger("liszt:updated");n.find(".new-category-container").append(n.new_category)});n.add_page.live("click",function(){var t=n.pagination_links.length,i=n.pagination_links.last().clone().removeClass("current");i.html(t+1);i.insertAfter(n.pagination_links.last());var s=e('<div class="page"><div class="delete-page-container"><span class="delete-page">delete page</span></div><div class="page-side left"><div class="sortable"></div><span class="button-primary add">+ add category</span></div><div class="page-side right"><div class="sortable"></div><span class="button-primary add">+ add category</span></div><div class="clear"></div></div>');e(".product-page-content").append(s);s.hide();a();f();r()});n.delete_page.live("click",function(){var t=e(this).parents(".page"),s=t.index();n.pagination_links.eq(s).remove();n.pages.eq(s).remove();toShow=s-1;s==0&&(toShow=0);a();f();n.pages.eq(toShow).show();n.pagination_links.eq(toShow).addClass("current");i();r()})}})(jQuery,window,document);